{{- /*
Template: container.go.tmpl
Generates: Container for composition apps that wires up all dependencies.
Only generated for composition apps (apps that compose internal packages).
Expects:
- InternalPackages: []InternalPackage
- ProjectName: string
*/ -}}
{{template "header" .}}
package bootstrap

import (
	"github.com/archesai/archesai/pkg/database"
	"github.com/archesai/archesai/pkg/events"
{{- range .InternalPackages }}
	{{ .Alias }}bootstrap "{{ .ImportPath }}/bootstrap"
{{- end }}
	postgresrepos "{{ .ProjectName }}/infrastructure/postgres/repositories"
	sqliterepos "{{ .ProjectName }}/infrastructure/sqlite/repositories"
)

// Services holds shared dependencies for all handlers.
type Services struct {
	DB        *database.Database
	Publisher events.Publisher
}

// NewHandlers creates all handlers with the given services.
// This wires up all internal package dependencies using the infrastructure layer.
func NewHandlers(services *Services) *Handlers {
	db := services.DB.SQLDB()

	if services.DB.IsSQLite() {
		return &Handlers{
{{- range .InternalPackages }}
{{- if eq .Name "auth" }}
			Auth: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers(
				sqliterepos.NewSQLiteAPIKeyRepository(db),
				sqliterepos.NewSQLiteAccountRepository(db),
				sqliterepos.NewSQLiteInvitationRepository(db),
				sqliterepos.NewSQLiteMemberRepository(db),
				sqliterepos.NewSQLiteOrganizationRepository(db),
				sqliterepos.NewSQLiteSessionRepository(db),
				sqliterepos.NewSQLiteUserRepository(db),
				services.Publisher,
			)),
{{- else if eq .Name "config" }}
			Config: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers()),
{{- else if eq .Name "executor" }}
			Executor: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers(
				sqliterepos.NewSQLiteExecutorRepository(db),
				services.Publisher,
			)),
{{- else if eq .Name "pipelines" }}
			Pipelines: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers(
				sqliterepos.NewSQLitePipelineRepository(db),
				sqliterepos.NewSQLiteRunRepository(db),
				sqliterepos.NewSQLiteToolRepository(db),
				services.Publisher,
			)),
{{- else if eq .Name "server" }}
			Server: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers()),
{{- else if eq .Name "storage" }}
			Storage: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers(
				sqliterepos.NewSQLiteArtifactRepository(db),
				sqliterepos.NewSQLiteLabelRepository(db),
				services.Publisher,
			)),
{{- end }}
{{- end }}
		}
	}

	// PostgreSQL
	pool := services.DB.PgxPool()
	return &Handlers{
{{- range .InternalPackages }}
{{- if eq .Name "auth" }}
		Auth: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers(
			postgresrepos.NewPostgresAPIKeyRepository(pool),
			postgresrepos.NewPostgresAccountRepository(pool),
			postgresrepos.NewPostgresInvitationRepository(pool),
			postgresrepos.NewPostgresMemberRepository(pool),
			postgresrepos.NewPostgresOrganizationRepository(pool),
			postgresrepos.NewPostgresSessionRepository(pool),
			postgresrepos.NewPostgresUserRepository(pool),
			services.Publisher,
		)),
{{- else if eq .Name "config" }}
		Config: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers()),
{{- else if eq .Name "executor" }}
		Executor: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers(
			postgresrepos.NewPostgresExecutorRepository(pool),
			services.Publisher,
		)),
{{- else if eq .Name "pipelines" }}
		Pipelines: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers(
			postgresrepos.NewPostgresPipelineRepository(pool),
			postgresrepos.NewPostgresRunRepository(pool),
			postgresrepos.NewPostgresToolRepository(pool),
			services.Publisher,
		)),
{{- else if eq .Name "server" }}
		Server: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers()),
{{- else if eq .Name "storage" }}
		Storage: {{ .Alias }}bootstrap.NewHTTPHandlers({{ .Alias }}bootstrap.NewApplicationHandlers(
			postgresrepos.NewPostgresArtifactRepository(pool),
			postgresrepos.NewPostgresLabelRepository(pool),
			services.Publisher,
		)),
{{- end }}
{{- end }}
	}
}

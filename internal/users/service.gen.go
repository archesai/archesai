// Code generated by archesai/codegen. DO NOT EDIT.

package users

import (
	"context"
	"errors"
	"log/slog"
	"time"

	"github.com/archesai/archesai/internal/database/postgresql"
)

// ServiceInterface defines the business logic operations
type ServiceInterface interface {
	Get(ctx context.Context, request GetUserRequestObject) (GetUserResponseObject, error)
	Update(ctx context.Context, request UpdateUserRequestObject) (UpdateUserResponseObject, error)
	Delete(ctx context.Context, request DeleteUserRequestObject) (DeleteUserResponseObject, error)
	List(ctx context.Context, request ListUsersRequestObject) (ListUsersResponseObject, error)
}

// Service implements the business logic
type Service struct {
	repo   Repository
	db     *postgresql.Queries
	logger *slog.Logger
}

// NewService creates a new service implementation
func NewService(repo Repository, db *postgresql.Queries, logger *slog.Logger) *Service {
	return &Service{
		repo:   repo,
		db:     db,
		logger: logger,
	}
}

// Get gets a user by ID
func (s *Service) Get(ctx context.Context, request GetUserRequestObject) (GetUserResponseObject, error) {
	// Call repository to fetch entity
	entity, err := s.repo.Get(ctx, request.ID)
	if err != nil {
		if errors.Is(err, ErrUserNotFound) {
			return GetUser404ApplicationProblemPlusJSONResponse{
				NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
					Detail: "User not found",
					Status: 404,
					Title:  "Not Found",
					Type:   "about:blank",
				},
			}, nil
		}

		s.logger.Error("Failed to get user", "error", err, "id", request.ID)
		return GetUser404ApplicationProblemPlusJSONResponse{
			NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
				Detail: "Failed to retrieve user",
				Status: 404,
				Title:  "Not Found",
				Type:   "about:blank",
			},
		}, nil
	}

	return GetUser200JSONResponse{
		Data: *entity,
	}, nil
}

// Update updates a user
func (s *Service) Update(ctx context.Context, request UpdateUserRequestObject) (UpdateUserResponseObject, error) {
	if request.Body == nil {
		return UpdateUser404ApplicationProblemPlusJSONResponse{
			NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
				Detail: "Request body is required",
				Status: 400,
				Title:  "Bad Request",
				Type:   "about:blank",
			},
		}, nil
	}

	// Get existing entity to verify it exists
	existing, err := s.repo.Get(ctx, request.ID)
	if err != nil {
		if errors.Is(err, ErrUserNotFound) {
			return UpdateUser404ApplicationProblemPlusJSONResponse{
				NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
					Detail: "User not found",
					Status: 404,
					Title:  "Not Found",
					Type:   "about:blank",
				},
			}, nil
		}
		s.logger.Error("Failed to get user for update", "error", err, "id", request.ID)
		return UpdateUser404ApplicationProblemPlusJSONResponse{
			NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
				Detail: "Internal server error",
				Status: 500,
				Title:  "Internal Server Error",
				Type:   "about:blank",
			},
		}, nil
	}

	// Update the entity with current timestamp
	existing.UpdatedAt = time.Now()

	// Call repository to persist changes
	updated, err := s.repo.Update(ctx, request.ID, existing)
	if err != nil {
		s.logger.Error("Failed to update user", "error", err, "id", request.ID)
		return UpdateUser404ApplicationProblemPlusJSONResponse{
			NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
				Detail: "Failed to update user",
				Status: 500,
				Title:  "Internal Server Error",
				Type:   "about:blank",
			},
		}, nil
	}

	return UpdateUser200JSONResponse{
		Data: *updated,
	}, nil
}

// Delete deletes a user
func (s *Service) Delete(ctx context.Context, request DeleteUserRequestObject) (DeleteUserResponseObject, error) {
	// Check if entity exists first
	_, err := s.repo.Get(ctx, request.ID)
	if err != nil {
		if errors.Is(err, ErrUserNotFound) {
			return DeleteUser404ApplicationProblemPlusJSONResponse{
				NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
					Detail: "User not found",
					Status: 404,
					Title:  "Not Found",
					Type:   "about:blank",
				},
			}, nil
		}
		s.logger.Error("Failed to get user for deletion", "error", err, "id", request.ID)
		return DeleteUser404ApplicationProblemPlusJSONResponse{
			NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
				Detail: "Internal server error",
				Status: 500,
				Title:  "Internal Server Error",
				Type:   "about:blank",
			},
		}, nil
	}

	// Delete the entity
	err = s.repo.Delete(ctx, request.ID)
	if err != nil {
		s.logger.Error("Failed to delete user", "error", err, "id", request.ID)
		return DeleteUser404ApplicationProblemPlusJSONResponse{
			NotFoundApplicationProblemPlusJSONResponse: NotFoundApplicationProblemPlusJSONResponse{
				Detail: "Failed to delete user",
				Status: 500,
				Title:  "Internal Server Error",
				Type:   "about:blank",
			},
		}, nil
	}

	return DeleteUser200JSONResponse{}, nil
}

// List lists all users
func (s *Service) List(ctx context.Context, request ListUsersRequestObject) (ListUsersResponseObject, error) {
	// Call repository to fetch entities using the request parameters
	entities, total, err := s.repo.List(ctx, request.Params)
	if err != nil {
		s.logger.Error("Failed to list users", "error", err)
		return ListUsers400ApplicationProblemPlusJSONResponse{
			BadRequestApplicationProblemPlusJSONResponse: BadRequestApplicationProblemPlusJSONResponse{
				Detail: "Failed to list users",
				Status: 500,
				Title:  "Internal Server Error",
				Type:   "about:blank",
			},
		}, nil
	}

	// Convert entities to response format
	var responseData []User
	for _, entity := range entities {
		if entity != nil {
			responseData = append(responseData, *entity)
		}
	}

	return ListUsers200JSONResponse{
		Data: responseData,
		Meta: struct {
			Total float32 `json:"total"`
		}{
			Total: float32(total),
		},
	}, nil
}

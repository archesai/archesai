{{- /*
Template: controller.go.tmpl
Generates: Individual HTTP handler file for a single operation
Expected data: HandlerControllerTemplateData
*/ -}}
{{template "header" .}}
package controllers

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"

	"github.com/google/uuid"
	"github.com/oapi-codegen/runtime"

	"github.com/archesai/archesai/pkg/server"
	"{{ .ProjectName }}/application"
	"{{ .ProjectName }}/models"
)

// ============================================================================
// {{ .Operation.ID }} - {{ .Operation.Method }} {{ .Operation.Path }}
// ============================================================================

// Handler type

// {{ .Operation.ID }}HandlerHTTP wraps the user handler for HTTP
type {{ .Operation.ID }}HandlerHTTP struct {
	handler application.{{ .Operation.ID }}Handler
}

// New{{ .Operation.ID }}HandlerHTTP creates a new HTTP handler wrapper
func New{{ .Operation.ID }}HandlerHTTP(handler application.{{ .Operation.ID }}Handler) *{{ .Operation.ID }}HandlerHTTP {
	return &{{ .Operation.ID }}HandlerHTTP{handler: handler}
}

// Register{{ .Operation.ID }}Route registers the HTTP route for {{ .Operation.ID }}
func Register{{ .Operation.ID }}Route(mux *http.ServeMux, handler *{{ .Operation.ID }}HandlerHTTP) {
	mux.HandleFunc("{{ .Operation.Method }} {{ .Operation.Path }}", handler.ServeHTTP)
}

// Request types

{{- if .Operation.GetQueryParams }}

// {{ .Operation.ID }}Params defines query parameters for {{ .Operation.ID }}
type {{ .Operation.ID }}Params struct {
{{- range .Operation.GetQueryParams }}
{{- $param := . }}
	{{ $param.Name }} {{ $param.GoType }} `json:"{{ camelCase $param.Name }},omitempty"`
{{- end }}
}
{{- end }}

{{- if .Operation.RequestBody }}

// {{ .Operation.ID }}RequestBody defines the request body for {{ .Operation.ID }}
type {{ .Operation.ID }}RequestBody struct {
{{- range .Operation.RequestBody.GetSortedProperties }}
{{- $field := . }}
	{{ $field.Name }} {{ if .NeedsPointer }}*{{ end }}{{ $field.GoType }} `json:"{{ $field.JSONTag }}"`
{{- end }}
}
{{- end }}

// Response types

type {{ .Operation.ID }}Response interface {
    Visit{{ .Operation.ID }}Response(w http.ResponseWriter) error
}
{{- range .Operation.Responses }}
{{- $response := . }}

{{- /* Generate nested type definitions for inline object properties */ -}}
{{- if and $response.IsSuccess $response.Properties }}
{{- range $response.GetSortedProperties }}
{{- $field := . }}
{{- if and (eq $field.Type "object") (gt (len $field.Properties) 0) }}

// {{ $.Operation.ID }}{{ $response.StatusCode }}Response{{ $field.Name }} defines the {{ lower $field.Name }} structure
type {{ $.Operation.ID }}{{ $response.StatusCode }}Response{{ $field.Name }} struct {
{{- range $field.GetSortedProperties }}
{{- $nestedField := . }}
    {{- if and (eq $nestedField.Type "array") $nestedField.Items (eq $nestedField.Items.Type "object") (gt (len $nestedField.Items.Properties) 0) }}
    {{ $nestedField.Name }} []struct {
        {{- range $nestedField.Items.GetSortedProperties }}
        {{- $itemField := . }}
        {{ $itemField.Name }} {{ $itemField.GoType }} `json:"{{ camelCase $itemField.JSONTag }}"`
        {{- end }}
    } `json:"{{ camelCase $nestedField.JSONTag }}"`
    {{- else }}
    {{ $nestedField.Name }} {{ $nestedField.GoType }} `json:"{{ camelCase $nestedField.JSONTag }}"`
    {{- end }}
{{- end }}
}
{{- end }}
{{- end }}
{{- end }}

type {{ $.Operation.ID }}{{ $response.StatusCode }}Response struct {
{{- if $response.IsSuccess }}
    {{- if eq $response.StatusCode "204" }}
    {{- else if $response.Properties }}
        {{- range $response.GetSortedProperties }}
            {{- $field := . }}
    {{- if and (eq $field.Type "object") (gt (len $field.Properties) 0) }}
    {{ $field.Name }} {{ $.Operation.ID }}{{ $response.StatusCode }}Response{{ $field.Name }} `json:"{{ camelCase $field.JSONTag }}"`
    {{- else }}
    {{ $field.Name }} {{ if .NeedsPointer }}*{{ end }}{{ $field.GoType }} `json:"{{ camelCase $field.JSONTag }}"`
    {{- end }}
        {{- end }}
    {{- end }}
{{- else }}
    server.ProblemDetails
{{- end }}
}

func (response {{ $.Operation.ID }}{{ $response.StatusCode }}Response) Visit{{ $.Operation.ID }}Response(w http.ResponseWriter) error {
{{- if eq $response.StatusCode "204" }}
    w.WriteHeader(204)
    return nil
{{- else if not $response.IsSuccess }}
    {{- if $response.ContentType }}
    w.Header().Set("Content-Type", "{{ $response.ContentType }}")
    {{- end }}
    w.WriteHeader({{ $response.StatusCode }})
    return json.NewEncoder(w).Encode(response.ProblemDetails)
{{- else }}
    {{- if $response.ContentType }}
    w.Header().Set("Content-Type", "{{ $response.ContentType }}")
    {{- end }}
    w.WriteHeader({{ $response.StatusCode }})
    return json.NewEncoder(w).Encode(response)
{{- end }}
}
{{- end }}

// ServeHTTP handles the {{ .Operation.Method }} {{ .Operation.Path }} endpoint.
func (h *{{ .Operation.ID }}HandlerHTTP) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()
	{{- if or .Operation.HasBearerAuth .Operation.HasCookieAuth }}

	// Extract session ID from context for authenticated operations
	sessionID, ok := ctx.Value(server.SessionIDContextKey).(uuid.UUID)
	if !ok {
		errorResp := {{ .Operation.ID }}401Response{
			ProblemDetails: server.NewUnauthorizedResponse("session required", r.URL.Path),
		}
		if err := errorResp.Visit{{ .Operation.ID }}Response(w); err != nil {
			fmt.Fprintf(w, "error writing response: %v", err)
		}
		return
	}
	{{- end }}

	// Build input from request
	input := &application.{{ .Operation.ID }}Input{}
	{{- if or .Operation.HasBearerAuth .Operation.HasCookieAuth }}
	input.SessionID = sessionID
	{{- end }}

	{{- range .Operation.GetPathParams }}
	{{- $param := . }}

	// Path parameter "{{ camelCase $param.Name }}"
	var {{ camelCase $param.Name }} {{ $param.GoType }}
	if err := runtime.BindStyledParameterWithOptions("simple", "{{ camelCase $param.Name }}", r.PathValue("{{ camelCase $param.Name }}"), &{{ camelCase $param.Name }}, runtime.BindStyledParameterOptions{ParamLocation: runtime.ParamLocationPath, Explode: false, Required: true}); err != nil {
		errorResp := {{ $.Operation.ID }}400Response{
			ProblemDetails: server.NewBadRequestResponse(fmt.Sprintf("Invalid format for parameter {{ camelCase $param.Name }}: %s", err), r.URL.Path),
		}
		if err := errorResp.Visit{{ $.Operation.ID }}Response(w); err != nil {
			fmt.Fprintf(w, "error writing response: %v", err)
		}
		return
	}
	input.{{ $param.Name }} = {{ camelCase $param.Name }}
	{{- end }}

	{{- range .Operation.GetHeaderParams }}
	{{- $param := . }}

	// Header parameter "{{ $param.Name }}"
	{{ camelCase $param.Name }} := r.Header.Get("{{ $param.Name }}")
	{{- if $param.Required }}
	if {{ camelCase $param.Name }} == "" {
		errorResp := {{ $.Operation.ID }}400Response{
			ProblemDetails: server.NewBadRequestResponse("Missing required header: {{ $param.Name }}", r.URL.Path),
		}
		if err := errorResp.Visit{{ $.Operation.ID }}Response(w); err != nil {
			fmt.Fprintf(w, "error writing response: %v", err)
		}
		return
	}
	{{- end }}
	input.{{ $param.Name }} = {{ camelCase $param.Name }}
	{{- end }}

	{{- if .Operation.GetQueryParams }}

	// Query parameters
	{{- range .Operation.GetQueryParams }}
	{{- $param := . }}

	// {{ if $param.Required }}Required{{ else }}Optional{{ end }} query parameter "{{ lower $param.Name }}"
	{{- if eq $param.Name "Filter" }}
	if err := runtime.BindQueryParameter("deepObject", true, {{ if $param.Required }}true{{ else }}false{{ end }}, "filter", r.URL.Query(), &input.{{ $param.Name }}); err != nil {
		errorResp := {{ $.Operation.ID }}400Response{
			ProblemDetails: server.NewBadRequestResponse(fmt.Sprintf("Invalid format for parameter filter: %s", err), r.URL.Path),
		}
		if err := errorResp.Visit{{ $.Operation.ID }}Response(w); err != nil {
			fmt.Fprintf(w, "error writing response: %v", err)
		}
		return
	}
	{{- else }}
	if err := runtime.BindQueryParameter("form", true, {{ if $param.Required }}true{{ else }}false{{ end }}, "{{ lower $param.Name }}", r.URL.Query(), &input.{{ $param.Name }}); err != nil {
		errorResp := {{ $.Operation.ID }}400Response{
			ProblemDetails: server.NewBadRequestResponse(fmt.Sprintf("Invalid format for parameter {{ lower $param.Name }}: %s", err), r.URL.Path),
		}
		if err := errorResp.Visit{{ $.Operation.ID }}Response(w); err != nil {
			fmt.Fprintf(w, "error writing response: %v", err)
		}
		return
	}
	{{- end }}
	{{- end }}
	{{- end }}

	{{- if .Operation.RequestBody }}

	// Request body
	body := &{{ .Operation.ID }}RequestBody{}
	if err := json.NewDecoder(r.Body).Decode(body); err != nil {
		errorResp := {{ .Operation.ID }}400Response{
			ProblemDetails: server.NewBadRequestResponse(err.Error(), r.URL.Path),
		}
		if err := errorResp.Visit{{ .Operation.ID }}Response(w); err != nil {
			fmt.Fprintf(w, "error writing response: %v", err)
		}
		return
	}
	{{- range .Operation.RequestBody.GetSortedProperties }}
	input.{{ .Name }} = body.{{ .Name }}
	{{- end }}
	{{- end }}

	// Execute handler
	{{- $successResponse := .Operation.GetSuccessResponse }}
	{{- if and $successResponse (eq $successResponse.StatusCode "204") }}
	if err := h.handler.Execute(ctx, input); err != nil {
		errorResp := {{ .Operation.ID }}500Response{
			ProblemDetails: server.NewInternalServerErrorResponse(err.Error(), r.URL.Path),
		}
		if err := errorResp.Visit{{ .Operation.ID }}Response(w); err != nil {
			fmt.Fprintf(w, "error writing response: %v", err)
		}
		return
	}

	response := {{ .Operation.ID }}204Response{}
	if err := response.Visit{{ .Operation.ID }}Response(w); err != nil {
		fmt.Fprintf(w, "error writing response: %v", err)
	}
	{{- else }}
	result, err := h.handler.Execute(ctx, input)
	if err != nil {
		errorResp := {{ .Operation.ID }}500Response{
			ProblemDetails: server.NewInternalServerErrorResponse(err.Error(), r.URL.Path),
		}
		if err := errorResp.Visit{{ .Operation.ID }}Response(w); err != nil {
			fmt.Fprintf(w, "error writing response: %v", err)
		}
		return
	}
	{{- $successCode := "200" }}
	{{- range .Operation.Responses }}
		{{- if and .IsSuccess (ne .StatusCode "204") }}
			{{- $successCode = .StatusCode }}
		{{- end }}
	{{- end }}

	// Map output to response
	response := {{ .Operation.ID }}{{ $successCode }}Response{}
	{{- if $successResponse }}
	{{- if $successResponse.Properties }}
	{{- range $successResponse.GetSortedProperties }}
	{{- $field := . }}
	{{- if and (eq $field.Type "object") (gt (len $field.Properties) 0) }}
	response.{{ $field.Name }} = {{ $.Operation.ID }}{{ $successCode }}Response{{ $field.Name }}(result.{{ $field.Name }})
	{{- else }}
	response.{{ $field.Name }} = result.{{ $field.Name }}
	{{- end }}
	{{- end }}
	{{- end }}
	{{- end }}

	if err := response.Visit{{ .Operation.ID }}Response(w); err != nil {
		fmt.Fprintf(w, "error writing response: %v", err)
	}
	{{- end }}
}


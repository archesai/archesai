{{- /*
Template: handler.gen.go.tmpl
Generates: Handler DTOs, interface, and (for non-custom) default implementation
Expected data: HandlerTemplateData
*/ -}}
{{template "header" .}}
package application

import (
	"context"
	"fmt"
	"time"

	"github.com/google/uuid"

	"{{ .ProjectName }}/models"
	"{{ .ProjectName }}/repositories"
	"github.com/archesai/archesai/pkg/events"
{{- if .NeedsServerModels }}
	servermodels "github.com/archesai/archesai/pkg/server/models"
{{- end }}
)

// ============================================================================
// {{ .Operation.ID }} Handler
// ============================================================================

// {{ .Operation.ID }}Input represents the input for the {{ .Operation.ID }} operation.
type {{ .Operation.ID }}Input struct {
{{- if or .Operation.HasBearerAuth .Operation.HasCookieAuth }}
	SessionID uuid.UUID
{{- end }}
{{- range .Operation.GetPathParams }}
	{{ pascalCase .Name }} {{ .GoType }}
{{- end }}
{{- range .Operation.GetHeaderParams }}
	{{ pascalCase .Name }} {{ .GoType }}
{{- end }}
{{- range .Operation.GetQueryParams }}
	{{ pascalCase .Name }} {{ if .NeedsPointer }}*{{ end }}{{ .GoType }}
{{- end }}
{{- if .Operation.RequestBody }}
{{- range .Operation.RequestBody.GetSortedProperties }}
	{{ .Name }} {{ if .NeedsPointer }}*{{ end }}{{ .GoType }}
{{- end }}
{{- end }}
}
{{- $successResponse := .Operation.GetSuccessResponse }}
{{- if and $successResponse (ne $successResponse.StatusCode "204") }}
{{- if $successResponse.Properties }}

{{- /* Generate nested type definitions for inline object properties */ -}}
{{- range $successResponse.GetSortedProperties }}
{{- $field := . }}
{{- if and (eq $field.Type "object") (gt (len $field.Properties) 0) }}

// {{ $.Operation.ID }}Output{{ $field.Name }} defines the {{ lower $field.Name }} structure in the output.
type {{ $.Operation.ID }}Output{{ $field.Name }} struct {
{{- range $field.GetSortedProperties }}
{{- $nestedField := . }}
{{- if and (eq $nestedField.Type "array") $nestedField.Items (eq $nestedField.Items.Type "object") (gt (len $nestedField.Items.Properties) 0) }}
	{{ $nestedField.Name }} []struct {
		{{- range $nestedField.Items.GetSortedProperties }}
		{{ .Name }} {{ .GoType }} `json:"{{ camelCase .JSONTag }}"`
		{{- end }}
	} `json:"{{ camelCase $nestedField.JSONTag }}"`
{{- else }}
	{{ $nestedField.Name }} {{ $nestedField.GoType }} `json:"{{ camelCase $nestedField.JSONTag }}"`
{{- end }}
{{- end }}
}
{{- end }}
{{- end }}

// {{ .Operation.ID }}Output represents the output for the {{ .Operation.ID }} operation.
type {{ .Operation.ID }}Output struct {
{{- range $successResponse.GetSortedProperties }}
{{- $field := . }}
{{- if and (eq $field.Type "object") (gt (len $field.Properties) 0) }}
	{{ $field.Name }} {{ $.Operation.ID }}Output{{ $field.Name }} `json:"{{ camelCase $field.JSONTag }}"`
{{- else if and (eq $field.Type "array") $field.Items (eq $field.Items.Type "object") (gt (len $field.Items.Properties) 0) }}
	{{ $field.Name }} []struct {
		{{- range $field.Items.GetSortedProperties }}
		{{ .Name }} {{ .GoType }} `json:"{{ camelCase .JSONTag }}"`
		{{- end }}
	} `json:"{{ camelCase $field.JSONTag }}"`
{{- else }}
	{{ $field.Name }} {{ if .NeedsPointer }}*{{ end }}{{ $field.GoType }} `json:"{{ camelCase $field.JSONTag }}"`
{{- end }}
{{- end }}
}
{{- end }}
{{- end }}

// {{ .Operation.ID }} defines the interface for the {{ .Operation.ID }} operation.
{{- if and $successResponse (eq $successResponse.StatusCode "204") }}
type {{ .Operation.ID }} interface {
	Execute(ctx context.Context, input *{{ .Operation.ID }}Input) error
}
{{- else }}
type {{ .Operation.ID }} interface {
	Execute(ctx context.Context, input *{{ .Operation.ID }}Input) (*{{ .Operation.ID }}Output, error)
}
{{- end }}

{{- if not .Operation.XCodegenCustomHandler }}

// {{ .Operation.ID }}Impl is the default implementation of {{ .Operation.ID }}.
type {{ .Operation.ID }}Impl struct {
	repo      repositories.{{ if .Operation.XCodegenRepository }}{{ .Operation.XCodegenRepository }}{{ else }}{{ .Operation.Tag }}{{ end }}Repository
{{- if ne .Operation.Method "GET" }}
	publisher events.Publisher
{{- end }}
}

// New{{ .Operation.ID }} creates a new {{ .Operation.ID }} handler.
func New{{ .Operation.ID }}(
	repo repositories.{{ if .Operation.XCodegenRepository }}{{ .Operation.XCodegenRepository }}{{ else }}{{ .Operation.Tag }}{{ end }}Repository,
{{- if ne .Operation.Method "GET" }}
	publisher events.Publisher,
{{- end }}
) {{ .Operation.ID }} {
	return &{{ .Operation.ID }}Impl{
		repo: repo,
{{- if ne .Operation.Method "GET" }}
		publisher: publisher,
{{- end }}
	}
}

// Execute performs the {{ .Operation.ID }} operation.
{{- if and $successResponse (eq $successResponse.StatusCode "204") }}
func (h *{{ .Operation.ID }}Impl) Execute(ctx context.Context, input *{{ .Operation.ID }}Input) error {
{{- if eq .Operation.Method "DELETE" }}
	// Delete from repository
	if err := h.repo.Delete(ctx, input.ID); err != nil {
		return fmt.Errorf("failed to delete {{ lower .Operation.Tag }}: %w", err)
	}

	// Publish domain event
	event := models.New{{ if .Operation.XCodegenRepository }}{{ .Operation.XCodegenRepository }}{{ else }}{{ .Operation.Tag }}{{ end }}DeletedEvent(input.ID)
	_ = h.publisher.Publish(ctx, event)

	return nil
{{- else }}
	return fmt.Errorf("not implemented")
{{- end }}
}
{{- else }}
func (h *{{ .Operation.ID }}Impl) Execute(ctx context.Context, input *{{ .Operation.ID }}Input) (*{{ .Operation.ID }}Output, error) {
{{- if eq .Operation.Method "GET" }}
{{- if hasPrefix .Operation.ID "List" }}
	// List from repository
	results, total, err := h.repo.List(ctx, 100, 0) // TODO: Use pagination from input
	if err != nil {
		return nil, fmt.Errorf("failed to list {{ lower .Operation.Tag }}s: %w", err)
	}

	// Map to output
	output := &{{ .Operation.ID }}Output{
		// TODO: Map results to output structure
		// Data: results,
		// Total: total,
	}
	_ = results
	_ = total

	return output, nil
{{- else }}
	// Get from repository
	{{- $hasID := false }}
	{{- range .Operation.GetPathParams }}
	{{- if eq (lower .Name) "id" }}
	{{- $hasID = true }}
	result, err := h.repo.Get(ctx, input.{{ pascalCase .Name }})
	{{- end }}
	{{- end }}
	{{- if not $hasID }}
	result, err := h.repo.Get(ctx, uuid.Nil) // TODO: Get correct ID
	{{- end }}
	if err != nil {
		return nil, fmt.Errorf("failed to get {{ lower .Operation.Tag }}: %w", err)
	}

	// Map to output
	output := &{{ .Operation.ID }}Output{
		// TODO: Map result fields to output
	}
	_ = result

	return output, nil
{{- end }}
{{- else if eq .Operation.Method "POST" }}
	// Create entity
	entity := &models.{{ if .Operation.XCodegenRepository }}{{ .Operation.XCodegenRepository }}{{ else }}{{ .Operation.Tag }}{{ end }}{
		ID:        uuid.New(),
		CreatedAt: time.Now().UTC(),
		UpdatedAt: time.Now().UTC(),
		// TODO: Map input fields to entity
	}

	// Save to repository
	created, err := h.repo.Create(ctx, entity)
	if err != nil {
		return nil, fmt.Errorf("failed to create {{ lower .Operation.Tag }}: %w", err)
	}

	// Publish event
	event := models.New{{ if .Operation.XCodegenRepository }}{{ .Operation.XCodegenRepository }}{{ else }}{{ .Operation.Tag }}{{ end }}CreatedEvent(created.ID)
	_ = h.publisher.Publish(ctx, event)

	// Map to output
	output := &{{ .Operation.ID }}Output{
		// TODO: Map created entity to output
	}
	_ = created

	return output, nil
{{- else if eq .Operation.Method "PATCH" }}
	// Get existing entity
	existing, err := h.repo.Get(ctx, input.ID)
	if err != nil {
		return nil, fmt.Errorf("failed to get {{ lower .Operation.Tag }}: %w", err)
	}

	// Update fields
	// TODO: Map input fields to entity
	existing.UpdatedAt = time.Now().UTC()

	// Save to repository
	updated, err := h.repo.Update(ctx, input.ID, existing)
	if err != nil {
		return nil, fmt.Errorf("failed to update {{ lower .Operation.Tag }}: %w", err)
	}

	// Publish event
	event := models.New{{ if .Operation.XCodegenRepository }}{{ .Operation.XCodegenRepository }}{{ else }}{{ .Operation.Tag }}{{ end }}UpdatedEvent(updated.ID)
	_ = h.publisher.Publish(ctx, event)

	// Map to output
	output := &{{ .Operation.ID }}Output{
		// TODO: Map updated entity to output
	}
	_ = updated

	return output, nil
{{- else }}
	return nil, fmt.Errorf("not implemented")
{{- end }}
}
{{- end }}
{{- end }}

options:
  machineType: "N1_HIGHCPU_8"

steps:
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    id: Get latest image tags
    args: ["./scripts/check-latest-sha.sh"]
    secretEnv:
      - GH_PAT

  - name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    id: Generate .env for stages
    args: ["./scripts/generate-dotenv.sh"]

  - name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    id: Create release in cloud deploy
    args: ["./scripts/create-release.sh"]
    env:
      - VERSION=${SHORT_SHA}

availableSecrets:
  secretManager:
    - versionName: projects/archesai/secrets/GH_PAT/versions/1
      env: GH_PAT

name: Update Docs

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-docs-makefile:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - run: make deps-go

      - run: |
          # Create the updated documentation content
          cat > docs/guides/makefile-commands.md << 'EOF'
          # Makefile Commands

          Run `make help` to see all available commands.

          ## Available Commands

          ```bash
          EOF

          # Append the make help output, removing ANSI color codes
          make help | sed 's/\x1B\[[0-9;]\{1,\}[A-Za-z]//g' >> docs/guides/makefile-commands.md

          # Close the code block
          echo '```' >> docs/guides/makefile-commands.md

      - id: changes
        run: |
          if git diff --quiet docs/guides/makefile-commands.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: docs/auto-update-docs-makefile
          title: 'docs: update Makefile commands documentation'
          body: |
            ## ğŸ“‹ Auto-generated Makefile Documentation Update

            This PR automatically updates the Makefile commands documentation with the latest `make help` output.

            ### Changes
            - Updated `docs/guides/makefile-commands.md` with current Makefile commands

            ğŸ¤– Generated with GitHub Actions
          commit-message: 'docs: update Makefile commands documentation'
          delete-branch: true

  update-docs-project-layout:
    needs: [update-docs-makefile]
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && always()
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main # Always get the latest main branch

      - run: |
          # Generate tree structure (excluding hidden files and common build artifacts)
          tree_output=$(tree -a -I '.git|node_modules|*.gen.go|dist|build|.DS_Store|*.log|coverage|.next|.turbo' --dirsfirst)

          # Create a temporary file with the new content
          cat > temp_project_layout.md << 'EOF'
          # Project Layout

          ## Directory Structure

          ```text
          EOF

          echo "$tree_output" >> temp_project_layout.md
          echo '```' >> temp_project_layout.md

          # Append the rest of the existing content after the directory structure
          # Extract everything after the first closing ``` in the original file
          sed -n '/^```$/,$p' docs/architecture/project-layout.md | tail -n +2 >> temp_project_layout.md

          # Replace the original file
          mv temp_project_layout.md docs/architecture/project-layout.md

      - id: changes
        run: |
          if git diff --quiet docs/architecture/project-layout.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: docs/auto-update-docs-project-layout
          title: 'docs: update project layout documentation'
          body: |
            ## ğŸ—ï¸ Auto-generated Project Layout Documentation Update

            This PR automatically updates the project layout documentation with the current directory structure.

            ### Changes
            - Updated `docs/architecture/project-layout.md` with current project structure

            ğŸ¤– Generated with GitHub Actions
          commit-message: 'docs: update project layout documentation'
          delete-branch: true

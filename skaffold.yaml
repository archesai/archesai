apiVersion: skaffold/v4beta11
kind: Config
profiles:
  - name: staging
    deploy:
      statusCheckDeadlineSeconds: 300
      tolerateFailuresUntilDeadline: true
    manifests:
      kustomize:
        paths:
          - 'deploy/kubernetes/overlays/stage-gcp'
  - name: production
    deploy:
      statusCheckDeadlineSeconds: 300
      tolerateFailuresUntilDeadline: true
    manifests:
      kustomize:
        paths:
          - 'deploy/kubernetes/overlays/production-gcp'
  - name: dev
    build:
      local:
        push: false
        useBuildkit: true
        concurrency: 0
      artifacts:
        - image: arches-api
          context: ./
          docker:
            target: development
            dockerfile: ./api/Dockerfile
          sync:
            manual:
              - src: '**/*'
                dest: .
        - image: arches-ui
          context: ./
          docker:
            target: development
            dockerfile: ./ui/Dockerfile
          sync:
            manual:
              - src: '**/*'
                dest: .
    deploy:
      statusCheckDeadlineSeconds: 300
      tolerateFailuresUntilDeadline: true
    manifests:
      kustomize:
        paths:
          - 'deploy/kubernetes/overlays/development'
    customActions:
      - name: seed
        executionMode:
          kubernetesCluster:
            overrides: '{"apiVersion":"batch/v1","kind":"Job","metadata":{"name":"arches-api-seed"},"spec":{"template":{"spec":{"restartPolicy":"Never","containers":[{"name":"arches-api-seed","image":"arches-api:dev","envFrom":[{"secretRef":{"name":"arches-api-config-secret"}}]}]}}}}'
        containers:
          - image: arches-api
            name: arches-api-seed
            command: ['pnpm']
            args: ['--filter', 'api', 'db:seed']
      - name: test-e2e
        executionMode:
          kubernetesCluster:
            overrides: '{"apiVersion":"batch/v1","kind":"Job","metadata":{"name":"arches-api-test-e2e"},"spec":{"template":{"spec":{"restartPolicy":"Never","containers":[{"name":"arches-api-test-e2e","image":"arches-api:dev","envFrom":[{"secretRef":{"name":"arches-api-config-secret"}}],"env":[{"name":"LOGGING_LEVEL","value":"silent"}]}]}}}}'
        containers:
          - image: arches-api
            name: arches-api-test-e2e
            command: ['pnpm']
            args: ['--filter', 'api', 'test:e2e']

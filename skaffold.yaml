apiVersion: skaffold/v4beta11
kind: Config
build:
  local:
    push: true
    useBuildkit: true
    concurrency: 0
  artifacts:
    - image: us-east4-docker.pkg.dev/archesai/images/api
      context: .
      docker:
        dockerfile: ./apps/api/Dockerfile
    - image: us-east4-docker.pkg.dev/archesai/images/ui
      context: .
      docker:
        dockerfile: ./apps/ui/Dockerfile
manifests:
  kustomize:
    paths:
      - deploy/kubernetes/base
deploy:
  statusCheckDeadlineSeconds: 300
  tolerateFailuresUntilDeadline: true
customActions:
  - name: migrate
    executionMode:
      kubernetesCluster:
        overrides: '{"apiVersion":"batch/v1","kind":"Job","metadata":{"name":"migrate"},"spec":{"template":{"spec":{"restartPolicy":"Never","containers":[{"name":"migrate","image":"api","envFrom":[{"secretRef":{"name":"archesai-config-secret"}}],"env":[{"name":"DATABASE_URL","valueFrom": {"secretKeyRef": {"name": "archesai-config-secret", "key": "ARCHES.DATABASE.ENDPOINT"}}}]}]}}}}'
    containers:
      - image: api
        name: migrate
        command: ['pnpm']
        args: ['--filter', 'api', 'migrations:prod']
  - name: seed
    executionMode:
      kubernetesCluster:
        overrides: '{"apiVersion":"batch/v1","kind":"Job","metadata":{"name":"seed"},"spec":{"template":{"spec":{"restartPolicy":"Never","containers":[{"name":"seed","image":"api","envFrom":[{"secretRef":{"name":"archesai-config-secret"}}], "env":[{"name":"DATABASE_URL","valueFrom": {"secretKeyRef": {"name": "archesai-config-secret", "key": "ARCHES.DATABASE.ENDPOINT"}}}]}]}}}}'
    containers:
      - image: api
        name: seed
        command: ['pnpm']
        args: ['--filter', 'api', 'db:seed']
  - name: test-e2e
    executionMode:
      kubernetesCluster:
        overrides: '{"apiVersion":"batch/v1","kind":"Job","metadata":{"name":"test-e2e"},"spec":{"template":{"spec":{"restartPolicy":"Never","containers":[{"name":"test-e2e","image":"api","envFrom":[{"secretRef":{"name":"archesai-config-secret"}}],"env":[{"name":"ARCHES.LOGGING.LEVEL","value":"silent"}, {"name":"DATABASE_URL","valueFrom": {"secretKeyRef": {"name": "archesai-config-secret", "key": "ARCHES.DATABASE.ENDPOINT"}}}]}]}}}}'
    containers:
      - image: api
        name: test-e2e
        command: ['pnpm']
        args: ['--filter', 'api', 'test:e2e']
profiles:
  - name: staging
    manifests:
      kustomize:
        paths:
          - deploy/kubernetes/overlays/stage-gcp
  - name: production
    manifests:
      kustomize:
        paths:
          - deploy/kubernetes/overlays/production-gcp
  - name: dev
    manifests:
      kustomize:
        paths:
          - deploy/kubernetes/overlays/development
    build:
      local:
        push: true
        useBuildkit: true
        concurrency: 0
      artifacts:
        - image: api
          context: .
          docker:
            target: development
            dockerfile: ./apps/api/Dockerfile
          sync:
            manual:
              - src: 'apps/api/**/*'
                dest: .
        - image: ui
          context: .
          docker:
            target: development
            dockerfile: ./apps/ui/Dockerfile
          sync:
            manual:
              - src: 'apps/ui/**/*'
                dest: .

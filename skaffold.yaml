apiVersion: skaffold/v4beta11
kind: Config
profiles:
  - name: staging
    deploy:
      statusCheckDeadlineSeconds: 300
      tolerateFailuresUntilDeadline: true
    manifests:
      kustomize:
        paths:
          - "deploy/kubernetes/overlays/stage-gcp"
  - name: production
    deploy:
      statusCheckDeadlineSeconds: 300
      tolerateFailuresUntilDeadline: true
    manifests:
      kustomize:
        paths:
          - "deploy/kubernetes/overlays/production-gcp"
  - name: dev
    build:
      local:
        push: false
        useBuildkit: true
        concurrency: 0
      artifacts:
        - image: arches-api
          context: ./api
          docker:
            target: development
            dockerfile: Dockerfile
          sync:
            manual:
              - src: "**/*"
                dest: .
        - image: arches-ui
          context: ./ui
          docker:
            target: development
            dockerfile: Dockerfile
          sync:
            manual:
              - src: "**/*"
                dest: .
      tagPolicy:
        inputDigest: {}
    deploy:
      statusCheckDeadlineSeconds: 300
      tolerateFailuresUntilDeadline: true
    manifests:
      kustomize:
        paths:
          - "deploy/kubernetes/overlays/development-min"
    customActions:
      - name: seed
        executionMode:
          kubernetesCluster:
            overrides: '{"apiVersion":"batch/v1","kind":"Job","metadata":{"name":"arches-api-seed"},"spec":{"template":{"spec":{"restartPolicy":"Never","containers":[{"name":"arches-api-seed","image":"arches-api:dev","envFrom":[{"secretRef":{"name":"arches-api-config-secret"}}]}]}}}}'
        containers:
          - image: arches-api
            name: arches-api-seed
            command: ["/bin/sh", "-c"]
            args:
              - |
                npm run db:seed
      - name: test-e2e
        executionMode:
          kubernetesCluster:
            overrides: '{"apiVersion":"batch/v1","kind":"Job","metadata":{"name":"arches-api-test-e2e"},"spec":{"template":{"spec":{"restartPolicy":"Never","containers":[{"name":"arches-api-test-e2e","image":"arches-api:dev","envFrom":[{"secretRef":{"name":"arches-api-config-secret"}}],"env":[{"name":"LOGGING_LEVEL","value":"silent"}]}]}}}}'
        containers:
          - image: arches-api
            name: arches-api-test-e2e
            command: ["/bin/sh", "-c"]
            args:
              - |
                npm run test:e2e

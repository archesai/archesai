apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

secretGenerator:
  - name: redis-ca-cert
    files:
      - ./redis-ca.pem

images:
  - name: api
    newName: us-east4-docker.pkg.dev/archesai/images/api
  - name: ui
    newName: us-east4-docker.pkg.dev/archesai/images/ui

resources:
  - ../../base
  - managedcertificate.yaml

patches:
  - path: api-deployment.patch.yaml
  - path: migrations-job-job.patch.yaml

  - target:
      version: v1
      group: networking.k8s.io
      kind: Ingress
      name: archesai-ingress
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          kubernetes.io/ingress.global-static-ip-name: archesai-static-ip
          networking.gke.io/managed-certificates: archesai-managed-certificate
          networking.gke.io/v1beta1.FrontendConfig: archesai-frontend-config
      - op: replace
        path: /spec/rules/0/host
        value: stage.api.archesai.com

  - target:
      kind: ManagedCertificate
      name: archesai-managed-certificate
    patch: |-
      - op: replace
        path: /spec/domains
        value: 
          - api.archesai.com
          - platform.archesai.com

  - target:
      kind: ServiceAccount
      name: api-service-account
    patch: |-
      - op: add
        path: /metadata/annotations
        value: 
          iam.gke.io/gcp-service-account: cloud-sql-proxy@archesai.iam.gserviceaccount.com

kind: Deployment
metadata:
  name: arches-api
spec:
  template:
    spec:
      containers:
        - name: arches-api
          env:
            - name: STRIPE_PRIVATE_API_KEY
              valueFrom:
                secretKeyRef:
                  key: STRIPE_PRIVATE_API_KEY
                  name: arches-api-config-secret
            - name: STRIPE_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  key: STRIPE_WEBHOOK_SECRET
                  name: arches-api-config-secret
            - name: EMAIL_SERVICE
              valueFrom:
                secretKeyRef:
                  key: EMAIL_SERVICE
                  name: arches-api-config-secret
            - name: EMAIL_USER
              valueFrom:
                secretKeyRef:
                  key: EMAIL_USER
                  name: arches-api-config-secret
            - name: EMAIL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: EMAIL_PASSWORD
                  name: arches-api-config-secret
            - name: PINECONE_API_KEY
              valueFrom:
                secretKeyRef:
                  key: PINECONE_API_KEY
                  name: arches-api-config-secret
            - name: PINECONE_INDEX
              valueFrom:
                secretKeyRef:
                  key: PINECONE_INDEX
                  name: arches-api-config-secret
            - name: REDIS_CA_CERT_PATH
              value: /usr/src/app/server-ca.pem
          volumeMounts:
            - mountPath: /usr/src/app/server-ca.pem
              name: arches-redis-ca-cert
              subPath: redis-ca.pem
        - name: cloud-sql-proxy
          image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.1
          args:
            - "--structured-logs"
            - "--port=5432"
            - "archesai:us-east1:arches-postgres"
          securityContext:
            runAsNonRoot: true
          resources:
            requests:
              memory: "100Mi"
              cpu: "100m"
            limits:
              memory: "200Mi"
              cpu: "200m"
      volumes:
        - name: arches-redis-ca-cert
          secret:
            secretName: arches-redis-ca-cert

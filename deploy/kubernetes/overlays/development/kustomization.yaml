apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - '../../base'

components:
  - ../../components/database
  - ../../components/redis
  - ../../components/storage
  - ../../components/ui
  - ../../components/grafana
  - ../../components/playwright
  - ../../components/unstructured

patches:
  - target:
      kind: Secret
      name: mkcert-tls
    patch: |-
      - op: add
        path: /type
        value: kubernetes.io/tls
  - target:
      kind: Job
      name: arches-api-upgrade
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: arches-api:dev
      - op: replace
        path: /spec/template/spec/restartPolicy
        value: OnFailure
  - target:
      kind: Deployment
      name: arches-api
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: arches-api:dev
      - op: replace
        path: /spec/template/spec/securityContext
        value:
          runAsUser: 0
          runAsGroup: 0
          fsGroup: 0
  - target:
      kind: Deployment
      name: arches-ui
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: arches-ui:dev
      - op: replace
        path: /spec/template/spec/securityContext
        value:
          runAsUser: 0
          runAsGroup: 0
          fsGroup: 0

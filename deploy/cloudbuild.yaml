options:
  machineType: "E2_HIGHCPU_32"

steps:
  - name: "gcr.io/kaniko-project/executor:latest"
    id: build-arches-api
    waitFor: ["-"]
    args:
      - --destination=us-east4-docker.pkg.dev/$PROJECT_ID/images/arches-api:$SHORT_SHA
      - --cache=true
      - --cache-ttl=24h
      - --context=./api
      - --snapshot-mode=redo
      - --use-new-run

  - name: "gcr.io/kaniko-project/executor:latest"
    id: build-arches-nlp
    waitFor: ["-"]
    args:
      - --destination=us-east4-docker.pkg.dev/$PROJECT_ID/images/arches-nlp:$SHORT_SHA
      - --cache=true
      - --cache-ttl=24h
      - --context=./nlp
      - --snapshot-mode=redo
      - --use-new-run

  # - name: "gcr.io/kaniko-project/executor:latest"
  #   id: build-arches-ui
  #   waitFor: ["-"]
  #   args:
  #     - --destination=us-east4-docker.pkg.dev/$PROJECT_ID/images/arches-ui:$SHORT_SHA
  #     - --cache=true
  #     - --cache-ttl=24h
  #     - --context=./ui

  - name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    id: Get latest image tags
    waitFor:
      - build-arches-api
      - build-arches-nlp
      # - build-arches-ui
    args: ["./deploy/scripts/01_get-release-values.sh"]
    secretEnv:
      - GITHUB_TOKEN

  # - name: "gcr.io/cloud-builders/docker"
  #   entrypoint: bash
  #   id: e2e-test
  #   args: ["./scripts/01_e2e-test.sh"]
  #   secretEnv:
  #     - GITHUB_TOKEN

  - name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    id: gen-dotenv
    waitFor:
      - Get latest image tags
    args: ["./scripts/02_generate-dotenv.sh"]

  - name: gcr.io/cloud-builders/gcloud
    waitFor:
      - gen-dotenv
    entrypoint: bash
    id: Create release in cloud deploy
    args: ["./scripts/03_create-release.sh"]

availableSecrets:
  secretManager:
    - versionName: projects/archesai/secrets/GH_PAT/versions/1
      env: GITHUB_TOKEN

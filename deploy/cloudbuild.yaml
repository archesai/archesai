options:
  machineType: "E2_HIGHCPU_32"

steps:
  # Step 0: Debug the workspace (Optional)
  - name: "gcr.io/cloud-builders/gcloud"
    id: debug-workspace
    entrypoint: bash
    args:
      - "-c"
      - |
        echo "Listing contents of /workspace:"
        ls -la /workspace
        echo "Current Git status:"
        git status

  # Step 1: Detect changes in api/ and nlp/ directories
  - name: "gcr.io/cloud-builders/git"
    id: detect-changes
    entrypoint: bash
    secretEnv:
      - GITHUB_TOKEN
    args:
      - "-c"
      - |
        #!/bin/bash
        set -e
        >/workspace/values.sh

        # Set up netrc file for authentication
        echo "machine github.com login x-access-token password $$GITHUB_TOKEN" > ~/.netrc
        chmod 600 ~/.netrc

        # Ensure we have the full history
        git fetch --unshallow

        # Check out the correct branch
        git checkout $BRANCH_NAME

        # Get the previous commit hash
        previous_commit=$(git rev-parse HEAD~1)

        # List files changed between the previous commit and the current one
        changed_files=$(git diff --name-only "$previous_commit" HEAD)

        echo "Changed files:"
        echo "$changed_files"

        # Detect changes in ./api/
        if echo "$changed_files" | grep -q '^api/'; then
          echo "export _API_CHANGED=true" >> /workspace/values.sh
        else
          echo "export _API_CHANGED=false" >> /workspace/values.sh
        fi

        # Detect changes in ./nlp/
        if echo "$changed_files" | grep -q '^nlp/'; then
          echo "export _NLP_CHANGED=true" >> /workspace/values.sh
        else
          echo "export _NLP_CHANGED=false" >> /workspace/values.sh
        fi

        cat /workspace/values.sh

  # Step 2: Conditionally build arches-api
  - name: "gcr.io/kaniko-project/executor:debug"
    id: build-arches-api
    waitFor: ["detect-changes"]
    entrypoint: /busybox/sh
    args:
      - "-c"
      - |
        . /workspace/values.sh

        if [ "$_API_CHANGED" = "true" ]; then
          echo "Changes detected in ./api/. Building arches-api..."
          /kaniko/executor \
            --destination=us-east4-docker.pkg.dev/$PROJECT_ID/images/arches-api:$SHORT_SHA \
            --cache=true \
            --cache-ttl=24h \
            --context=./api \
            --snapshot-mode=redo \
            --use-new-run
        else
          echo "No changes detected in ./api/. Skipping arches-api build."
        fi

  # Step 3: Conditionally build arches-nlp
  - name: "gcr.io/kaniko-project/executor:debug"
    id: build-arches-nlp
    waitFor: ["detect-changes"]
    entrypoint: /busybox/sh
    args:
      - "-c"
      - |
        . /workspace/values.sh

        if [ "$_NLP_CHANGED" = "true" ]; then
          echo "Changes detected in ./nlp/. Building arches-nlp..."
          /kaniko/executor \
            --destination=us-east4-docker.pkg.dev/$PROJECT_ID/images/arches-nlp:$SHORT_SHA \
            --cache=true \
            --cache-ttl=24h \
            --context=./nlp \
            --snapshot-mode=redo \
            --use-new-run
        else
          echo "No changes detected in ./nlp/. Skipping arches-nlp build."
        fi

availableSecrets:
  secretManager:
    - versionName: projects/archesai/secrets/GH_PAT/versions/1
      env: GITHUB_TOKEN

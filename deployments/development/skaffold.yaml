# yaml-language-server: $schema=https://raw.githubusercontent.com/GoogleContainerTools/skaffold/main/docs-v2/content/en/schemas/v4beta13.json
apiVersion: skaffold/v4beta13
kind: Config
build:
  local:
    push: true
    useBuildkit: true
    concurrency: 0
  tagPolicy:
    gitCommit:
      ignoreChanges: true
      variant: AbbrevCommitSha
  artifacts:
    - image: api
      context: .
      docker:
        dockerfile: ./deploy/dockerfiles/Dockerfile.api
    - image: platform
      context: .
      docker:
        dockerfile: ./deploy/dockerfiles/Dockerfile.platform
manifests:
  kustomize:
    paths:
      - deploy/kubernetes/base
deploy:
  statusCheckDeadlineSeconds: 300
  tolerateFailuresUntilDeadline: true
customActions:
  - name: migrate
    executionMode:
      kubernetesCluster: {}
    containers:
      - image: api
        name: migrate
        command: [pnpm]
        args: [--filter, api, migrations:prod]
  - name: seed
    executionMode:
      kubernetesCluster: {}
    containers:
      - image: api
        name: seed
        command: [pnpm]
        args: [--filter, api, database:seed]
  - name: test-e2e
    executionMode:
      kubernetesCluster: {}
    containers:
      - image: api
        name: test-e2e
        command: [pnpm]
        args: [--filter, api, test:e2e]
profiles:
  - name: dev
    manifests:
      kustomize:
        buildArgs:
          - --enable-helm
        paths:
          - kubernetes/overlays/development
    build:
      artifacts:
        - image: api
          context: .
          docker:
            target: development
            dockerfile: ./apps/api/Dockerfile
          sync:
            manual:
              - src: apps/api/**/*
                dest: .
        - image: platform
          context: .
          docker:
            target: development
            dockerfile: ./apps/platform/Dockerfile
          sync:
            manual:
              - src: apps/platform/**/*
                dest: .
